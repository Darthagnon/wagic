version: 2.1
jobs:
  build:
    working_directory: ~/project
    docker:
      - image: circleci/openjdk:8-jdk
    environment:
      - BUILD_ANDROID=YES
    parallelism: 2
    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: |
            curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
            #!/bin/bash -eo pipefail
            curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
            echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
            sudo apt-get update
            sudo apt-get -qq install wget unzip libgd-dev libc6-i386 lib32stdc++6 lib32gcc-s1 lib32ncurses6 lib32z1 jq ant lib32ncurses6 libgd-dev

            wget https://dl.google.com/android/repository/android-ndk-r22-linux-x86_64.zip -nv
            wget http://dl.google.com/android/android-sdk_r24.4.1-linux.tgz -nv

      - run:
          name: Setup Android
          command: |
            export ANDROID="android-sdk-linux/tools/android"
            export PATH="$PATH:$ANDROID_HOME/tools"
            unzip android-ndk-r22-linux-x86_64.zip
            tar -zxf android-sdk_r24.4.1-linux.tgz
            $ANDROID list sdk --extended -a &&
            echo yes | $ANDROID update sdk -a -t tools,platform-tools,build-tools-23.0.1,android-23 --no-ui --force --no-https
            sudo apt-get install openjdk-11-jdk
            export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
            export PATH=$JAVA_HOME/bin:$PATH
           
      - run:
          name: Build Android
          command: |
            echo $PWD
            bash ./tools/circle-script.sh
      - run:
          name: Upload APK to GitHub Releases
          command: |
            curl -L https://github.com/aktau/github-release/releases/download/v0.7.2/linux-amd64-github-release.tar.bz2 | tar xjvf -
            ./bin/linux/amd64/github-release upload \
              --user EduardoMunozGomez \
              --repo wagic \
              --tag androide \
              --name Wagic-debug.apk \
              --file projects/mtg/Android/bin/Wagic-debug.apk \
              --security-token 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

